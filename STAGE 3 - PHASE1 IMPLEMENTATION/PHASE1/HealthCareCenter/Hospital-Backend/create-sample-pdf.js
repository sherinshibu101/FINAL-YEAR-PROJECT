/**
 * Create sample lab report PDFs for testing
 */
const PDFDocument = require('pdfkit');
const fs = require('fs');
const path = require('path');

const labReportsDir = path.join(__dirname, 'storage/lab-reports');

// Ensure directory exists
if (!fs.existsSync(labReportsDir)) {
  fs.mkdirSync(labReportsDir, { recursive: true });
}

function createSampleLabPDF(filename) {
  return new Promise((resolve, reject) => {
    const doc = new PDFDocument({
      size: 'A4',
      margin: 40,
      buffered: false
    });

    const filepath = path.join(labReportsDir, filename);
    const stream = fs.createWriteStream(filepath);

    doc.pipe(stream);

    // Header
    doc
      .fontSize(20)
      .font('Helvetica-Bold')
      .text('LABORATORY TEST REPORT', { align: 'center' })
      .moveDown(0.5);

    doc
      .fontSize(10)
      .font('Helvetica')
      .text('HealthCare Center Laboratory', { align: 'center' })
      .text('Accredited Medical Laboratory', { align: 'center' })
      .moveDown(0.5);

    // Horizontal line
    doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();
    doc.moveDown(1);

    // Patient Information
    doc
      .fontSize(11)
      .font('Helvetica-Bold')
      .text('PATIENT INFORMATION')
      .moveDown(0.2);

    doc
      .fontSize(9)
      .font('Helvetica')
      .text('Patient Name: Alice Brown')
      .text('Patient ID: P-001')
      .text('Date of Birth: 1980-05-15')
      .text('Gender: Female')
      .text('Age: 44 years')
      .moveDown(0.5);

    // Test Information
    doc
      .fontSize(11)
      .font('Helvetica-Bold')
      .text('TEST INFORMATION')
      .moveDown(0.2);

    doc
      .fontSize(9)
      .font('Helvetica')
      .text('Test Type: Complete Blood Count (CBC)')
      .text('Specimen Type: Whole Blood')
      .text('Collection Date: 2024-11-25')
      .text('Received Date: 2024-11-25')
      .text('Report Date: 2024-11-26')
      .text('Status: Completed')
      .moveDown(1);

    // Results
    doc
      .fontSize(11)
      .font('Helvetica-Bold')
      .text('LABORATORY RESULTS')
      .moveDown(0.3);

    // Table header
    const tableTop = doc.y;
    const col1 = 40;
    const col2 = 250;
    const col3 = 380;
    const col4 = 480;

    doc
      .fontSize(9)
      .font('Helvetica-Bold');

    doc.text('Test Name', col1, tableTop);
    doc.text('Result', col2, tableTop);
    doc.text('Reference Range', col3, tableTop);
    doc.text('Unit', col4, tableTop);

    // Table rows
    let currentY = tableTop + 25;
    doc.fontSize(9).font('Helvetica');

    const results = [
      { test: 'White Blood Cell (WBC)', result: '7.2', range: '4.5-11.0', unit: '10^9/L' },
      { test: 'Red Blood Cell (RBC)', result: '4.8', range: '4.5-5.9', unit: '10^12/L' },
      { test: 'Hemoglobin (HGB)', result: '14.2', range: '12.0-16.0', unit: 'g/dL' },
      { test: 'Hematocrit (HCT)', result: '42.5', range: '36-46', unit: '%' },
      { test: 'Mean Corpuscular Volume (MCV)', result: '88', range: '80-100', unit: 'fL' },
      { test: 'Platelet Count (PLT)', result: '245', range: '150-400', unit: '10^9/L' }
    ];

    results.forEach(r => {
      if (currentY > 700) {
        doc.addPage();
        currentY = 40;
      }
      doc.text(r.test, col1, currentY);
      doc.text(r.result, col2, currentY);
      doc.text(r.range, col3, currentY);
      doc.text(r.unit, col4, currentY);
      currentY += 20;
    });

    currentY += 10;
    doc.moveTo(40, currentY).lineTo(555, currentY).stroke();
    currentY += 15;

    // Interpretation
    doc
      .fontSize(11)
      .font('Helvetica-Bold')
      .text('INTERPRETATION', 40, currentY);

    currentY += 25;
    doc
      .fontSize(9)
      .font('Helvetica');

    const interpretation = `All blood cell counts are within normal limits. No abnormalities detected. 
The Complete Blood Count (CBC) results are normal and indicate a healthy blood profile.
No signs of infection, anemia, or clotting disorders.`;

    doc.text(interpretation, 40, currentY, { width: 475, height: 100 });

    currentY = doc.y + 20;

    // Footer
    doc.moveTo(40, currentY).lineTo(555, currentY).stroke();
    doc
      .fontSize(8)
      .font('Helvetica')
      .text(
        'This report was generated by the Laboratory Information System. Report is valid with authorized pathologist signature.',
        40,
        currentY + 10,
        { align: 'center' }
      );

    // End document
    doc.end();

    stream.on('finish', () => {
      console.log(`✓ Sample PDF created: ${filename}`);
      resolve(filepath);
    });

    stream.on('error', (err) => {
      console.error(`✗ Error creating PDF: ${err.message}`);
      reject(err);
    });

    doc.on('error', (err) => {
      console.error(`✗ Document error: ${err.message}`);
      reject(err);
    });
  });
}

async function main() {
  try {
    console.log('Creating sample lab report PDFs...');
    await createSampleLabPDF('cbc-alice-2024-11-25.pdf');
    await createSampleLabPDF('blood-test-bob-2024-11-20.pdf');
    await createSampleLabPDF('urinalysis-carol-2024-11-22.pdf');
    console.log('✓ All sample PDFs created successfully!');
  } catch (error) {
    console.error('✗ Error:', error.message);
  }
}

main();
